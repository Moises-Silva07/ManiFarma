<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>ManiFarma Analytics</title>

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <link rel="stylesheet" href="/css/global/global_menu_funcionario.css">
    <link rel="stylesheet" href="/css/relatorios_pedido.css">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark glass-nav fixed-top">
    <div class="container-fluid px-4">
        <a href="/html/menu_funcionario/menu_funcionario.html" class="navbar-brand d-flex align-items-center gap-2">
            <img src="/img/logo.png" alt="Logo" height="40">
            <span class="brand-text">ManiFarma <span class="text-primary-yellow">Analytics</span></span>
        </a>

        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navMenu">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navMenu">
            <ul class="navbar-nav ms-auto align-items-center">
                <li class="nav-item"><a class="nav-link" href="/html/menu_funcionario/pedido_validacao_funcionario.html">Pedidos</a></li>
                <li class="nav-item"><a class="nav-link" href="/html/menu_funcionario/itens_funcionario.html">Itens</a></li>
                <li class="nav-item ms-3">
                    <div class="user-badge">
                        <i class="fa-solid fa-user-tie"></i> Admin
                    </div>
                </li>
            </ul>
        </div>
    </div>
</nav>

<main class="dashboard-container">

    <div class="dashboard-header fade-in-down">
        <div class="header-title">
            <h1>Visão Geral</h1>
            <p class="text-muted" id="dataAtualDisplay"></p>
        </div>

        <div class="filter-bar glass-card">
            <div class="filter-group">
                <label><i class="fa-regular fa-calendar"></i> De</label>
                <input id="fromDate" type="date">
            </div>
            <div class="filter-group">
                <label><i class="fa-regular fa-calendar-check"></i> Até</label>
                <input id="toDate" type="date">
            </div>
            <div class="filter-group small">
                <label>Top</label>
                <input id="limit" type="number" min="1" max="20" value="5">
            </div>
            <div class="filter-actions">
                <button id="btnAplicar" class="btn-glow"><i class="fa-solid fa-bolt"></i> Atualizar</button>
                <button id="btnReset" class="btn-icon" title="Limpar"><i class="fa-solid fa-rotate"></i></button>
            </div>
        </div>
    </div>

    <div class="kpi-grid fade-in-up">
        <div class="kpi-card glass-card kpi-receita">
            <div class="kpi-icon">
                <i class="fa-solid fa-sack-dollar"></i>
            </div>
            <div class="kpi-info">
                <span>Receita Total</span>
                <h2 id="receitaTotal">R$ 0,00</h2>
            </div>
            <div class="kpi-chart-bg"></div> </div>

        <div class="kpi-card glass-card">
            <div class="kpi-icon icon-blue">
                <i class="fa-solid fa-cart-shopping"></i>
            </div>
            <div class="kpi-info">
                <span>Total Pedidos</span>
                <h2 id="totalPedidos">0</h2>
            </div>
        </div>

        <div class="kpi-card glass-card">
            <div class="kpi-icon icon-purple">
                <i class="fa-solid fa-receipt"></i>
            </div>
            <div class="kpi-info">
                <span>Ticket Médio</span>
                <h2 id="ticketMedio">R$ 0,00</h2>
            </div>
        </div>

        <div class="kpi-card glass-card kpi-alert">
            <div class="kpi-icon icon-orange">
                <i class="fa-regular fa-clock"></i>
            </div>
            <div class="kpi-info">
                <span>Aguardando</span>
                <h2 id="pendentes">0</h2>
            </div>
        </div>
    </div>

    <div class="charts-grid fade-in-up delay-1">

        <div class="chart-box glass-card area-clientes">
            <div class="box-header">
                <h3><i class="fa-solid fa-crown text-primary-yellow"></i> Top Clientes</h3>
                <button class="btn-more"><i class="fa-solid fa-ellipsis"></i></button>
            </div>
            <div class="canvas-wrapper">
                <canvas id="clientsChart"></canvas>
            </div>
        </div>

        <div class="chart-box glass-card area-status">
            <div class="box-header">
                <h3>Status dos Pedidos</h3>
            </div>
            <div class="canvas-wrapper doughnut-wrapper">
                <canvas id="statusChart"></canvas>
                <div class="donut-center">
                    <span id="centerTotal">0</span>
                    <small>Total</small>
                </div>
            </div>
            <div class="status-legend mt-3" id="statusLegend">
            </div>
        </div>

        <div class="chart-box glass-card area-funcionarios">
            <div class="box-header">
                <h3><i class="fa-solid fa-user-group text-blue"></i> Performance da Equipe</h3>
            </div>
            <div class="canvas-wrapper">
                <canvas id="employeesChart"></canvas>
            </div>
        </div>

    </div>

</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
<script src="/js/validarToken.js"></script>

<script>
    validarToken();

    Chart.defaults.color = '#a0a0a0';
    Chart.defaults.font.family = "'Poppins', sans-serif";
    Chart.defaults.scale.grid.color = 'rgba(255, 255, 255, 0.05)';

    const API_SUMMARY = "/api/reports/summary";
    const API_TOP_CLIENTS = "/api/reports/clients/top";
    const API_TOP_EMPLOYEES = "/api/reports/employees/top";

    let statusChart, clientsChart, employeesChart;

    const fmtBRL = v => Number(v||0).toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
    const $ = id => document.getElementById(id);

    async function loadSummary(from, to) {
        const params = new URLSearchParams();
        if(from) params.set('from', from);
        if(to) params.set('to', to);

        const res = await fetch(`${API_SUMMARY}?${params}`, {
            headers: {'Authorization': `Bearer ${localStorage.getItem("token")}`}
        });
        const data = await res.json();

        animateValue("totalPedidos", 0, data.totalPedidos || 0, 1000);
        animateValue("pendentes", 0, data.pendentes || 0, 1000);

        $('receitaTotal').textContent = fmtBRL(data.receitaTotal);

        const ticket = data.totalPedidos > 0 ? (data.receitaTotal / data.totalPedidos) : 0;
        $('ticketMedio').textContent = fmtBRL(ticket);

        updateStatusChart(data);
    }

    async function loadCharts(from, to, limit) {
        const headers = {'Authorization': `Bearer ${localStorage.getItem("token")}`};
        const params = new URLSearchParams({limit});
        if(from) params.set('from', from);
        if(to) params.set('to', to);

        const [resClients, resEmp] = await Promise.all([
            fetch(`${API_TOP_CLIENTS}?${params}`, {headers}),
            fetch(`${API_TOP_EMPLOYEES}?${params}`, {headers})
        ]);

        const clients = await resClients.json();
        const employees = await resEmp.json();

        updateClientsChart(clients);
        updateEmployeesChart(employees);
    }

    function updateStatusChart(data) {
        const ctx = $('statusChart').getContext('2d');
        const total = (data.pendentes + data.pagos + data.concluidos + data.cancelados);
        $('centerTotal').textContent = total;

        if(statusChart) statusChart.destroy();

        statusChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Pendentes', 'Pagos', 'Concluídos', 'Cancelados'],
                datasets: [{
                    data: [data.pendentes, data.pagos, data.concluidos, data.cancelados],
                    backgroundColor: ['#f39c12', '#3498db', '#2ecc71', '#e74c3c'],
                    borderWidth: 0,
                    hoverOffset: 10
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '75%',
                plugins: { legend: { display: false } }
            }
        });

        const legendHTML = `
            <div class="legend-item"><span class="dot" style="background:#f39c12"></span> Pendentes (${data.pendentes})</div>
            <div class="legend-item"><span class="dot" style="background:#3498db"></span> Pagos (${data.pagos})</div>
            <div class="legend-item"><span class="dot" style="background:#2ecc71"></span> Concluídos (${data.concluidos})</div>
            <div class="legend-item"><span class="dot" style="background:#e74c3c"></span> Cancelados (${data.cancelados})</div>
        `;
        $('statusLegend').innerHTML = legendHTML;
    }

    function updateClientsChart(data) {
        const ctx = $('clientsChart').getContext('2d');
        if(clientsChart) clientsChart.destroy();

        const gradient = ctx.createLinearGradient(0, 0, 0, 400);
        gradient.addColorStop(0, '#FEE715');
        gradient.addColorStop(1, 'rgba(254, 231, 21, 0.1)');

        clientsChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.map(c => c.clientName || 'ID '+c.clientId),
                datasets: [{
                    label: 'Total Gasto',
                    data: data.map(c => c.totalSpent),
                    backgroundColor: gradient,
                    borderRadius: 6,
                    barThickness: 30
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: { color: 'rgba(255,255,255,0.05)' }
                    },
                    x: { grid: { display: false } }
                }
            }
        });
    }

    function updateEmployeesChart(data) {
        const ctx = $('employeesChart').getContext('2d');
        if(employeesChart) employeesChart.destroy();

        employeesChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.map(e => e.employeeName || 'ID '+e.employeeId),
                datasets: [{
                    label: 'Vendas Realizadas',
                    data: data.map(e => e.totalValueHandled),
                    borderColor: '#00d2ff',
                    backgroundColor: 'rgba(0, 210, 255, 0.1)',
                    tension: 0.4,
                    fill: true,
                    pointBackgroundColor: '#00d2ff',
                    pointRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { grid: { color: 'rgba(255,255,255,0.05)' } },
                    x: { grid: { display: false } }
                }
            }
        });
    }

    function getFilters() {
        return {
            from: $('fromDate').value,
            to: $('toDate').value,
            limit: $('limit').value
        };
    }

    async function refresh() {
        const {from, to, limit} = getFilters();
        await Promise.all([
            loadSummary(from, to),
            loadCharts(from, to, limit)
        ]);
    }

    function animateValue(id, start, end, duration) {
        if (start === end) return;
        const range = end - start;
        let current = start;
        const increment = end > start ? 1 : -1;
        const stepTime = Math.abs(Math.floor(duration / range));
        const obj = document.getElementById(id);
        const timer = setInterval(function() {
            current += increment;
            obj.textContent = current;
            if (current == end) clearInterval(timer);
        }, Math.max(stepTime, 10));
    }

    $('btnAplicar').onclick = refresh;
    $('btnReset').onclick = () => {
        $('fromDate').value = ''; $('toDate').value = ''; $('limit').value = 5;
        refresh();
    };

    refresh();

</script>
</body>
</html>